{{- if .Values.bridge.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: meshtastic-bridge
  labels:
    app: meshtastic-bridge
spec:
  replicas: 1
  selector:
    matchLabels:
      app: meshtastic-bridge
  template:
    metadata:
      labels:
        app: meshtastic-bridge
    spec:
      containers:
      - name: bridge
        image: "{{ .Values.bridge.image }}"
        imagePullPolicy: IfNotPresent
        command: ["python", "meshtastic_bridge.py"]
        env:
        - name: BRIDGE_CONFIG
          value: "/etc/meshtastic-bridge/config.yaml"
        volumeMounts:
        - name: config-volume
          mountPath: /etc/meshtastic-bridge
      volumes:
      - name: config-volume
        configMap:
          name: meshtastic-bridge-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: meshtastic-bridge-config
data:
  config.yaml: |
    meshtastic:
      connection_type: network
      network:
        host: "meshtastic-node"
        port: 4403
      channel: 0
    
    matrix:
      homeserver: "http://matrix-server:8008"
      user_id: "@reduit_bot:{{ .Values.global.domain }}"
      access_token: {{ .Values.bridge.matrixToken | quote }}
      room_id: {{ .Values.bridge.matrixRoom | quote }}
    
    logging:
      level: INFO
{{- end }}
